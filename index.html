<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងតំណគេហទំព័រ</title>
    <link rel="icon" type="image/png" href="https://img.uxcel.com/lessons/links-accessibility-1705345911300-2x.svg">
    <!-- 1. Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Tải React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Tải Babel Standalone (để dịch JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Tải Google Font (Kantumruy Pro) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">
    
    <!-- 4.5 [FIX] Tải Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>
    
    <style>
      /* អនុវត្ត font ទៅលើទំព័រទាំងមូល */
      body {
        font-family: 'Kantumruy Pro', sans-serif;
      }
      /* សម្រាប់ Custom Toggle Switch របស់ Admin */
      .toggle-checkbox:checked {
        @apply: bg-blue-600;
        right: 0;
      }
      .toggle-checkbox:checked + .toggle-label {
        @apply: bg-blue-600;
      }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-gray-50">

    <!-- 5. នេះគឺជាកន្លែងដែល React App នឹងបង្ហាញ -->
    <div id="root"></div>

    <!-- 6. នេះគឺជាកូដ React ទាំងអស់ -->
    <script type="text/babel">
        // ប្រើ global variables ពី script ខាងលើ
        const { useState, useEffect, Fragment } = React;

        // 1. ការកំណត់រចនាសម្ព័ន្ធ Firebase របស់អ្នក
        const firebaseConfig = {
          apiKey: "AIzaSyAuNfZqCCpZVR6Rz3nOGa3SxwGTfWy4wJQ",
          authDomain: "controlwebsite.firebaseapp.com",
          projectId: "controlwebsite",
          storageBucket: "controlwebsite.firebasestorage.app",
          messagingSenderId: "512653236361",
          appId: "1:512653236361:web:1d0f21a9ebe06724c1ce58",
          measurementId: "G-SDHGT81ZDY",
          databaseURL: "https://controlwebsite-default-rtdb.firebaseio.com"
        };

        // 2. ចាប់ផ្ដើម Firebase (v8 compat syntax)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        // --- រូបតំណាង (Icons) ជា SVG ---
        const PlusIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v12m6-6H6" />
          </svg>
        );
        const TrashIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        );
        const LinkIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101" />
          </svg>
        );
        const EditIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
          </svg>
        );
        const LogoutIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
        );
        const KeyIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a4 4 0 11-8 0 4 4 0 018 0zM9 15v-2m6 0v2m2 4.5a.5.5 0 01-.5.5h-8a.5.5 0 01-.5-.5v-1a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v1z" />
          </svg>
        );
        const UserIcon = () => (
          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        );
        const LockIcon = () => (
           <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3h8z" />
           </svg>
        );
        
        const EyeIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z" /></svg>
        );
        const EyeOffIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.875C12.024 19.943 9.879 19.943 8 18.875m0 0C6.12 17.807 4.024 16.03 2.458 12C3.732 7.943 7.523 5 12 5c1.118 0 2.204.17 3.223.484m2.62.978C19.33 7.547 20.89 9.61 21.542 12c-1.274 4.057-5.064 7-9.542 7-1.118 0-2.204-.17-3.223-.484m-2.62-.978l-3.02-3.02m0 0l-3.02 3.02" /></svg>
        );
        
        const RemoveDeviceIcon = () => (
           <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 10a1 1 0 11-2 0 1 1 0 012 0zm10 0a1 1 0 11-2 0 1 1 0 012 0zm-5 4a1 1 0 100 2 1 1 0 000-2zm-6.828 2.828A4 4 0 017.172 15h9.656a4 4 0 012.828 6.828" /></svg>
        );
        // --- ចប់ ផ្នែករូបតំណាង ---
        
        // --- Component: LoginForm ---
        function LoginForm({ onLogin }) {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');
          const [loading, setLoading] = useState(false);
          const [showPassword, setShowPassword] = useState(false);

          const handleSubmit = (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);

            // 1. ពិនិត្យ Admin
            db.ref('admins').once('value')
              .then((adminSnapshot) => {
                const adminsData = adminSnapshot.val();
                if (adminsData) {
                  for (const adminId in adminsData) {
                    const admin = adminsData[adminId];
                    if (admin.username === username && admin.password === password) {
                      onLogin({ name: admin.username, role: 'admin' });
                      setLoading(false);
                      return; 
                    }
                  }
                }
                
                // 2. ពិនិត្យ User (Author)
                db.ref('authors').once('value')
                  .then((authorSnapshot) => {
                    const authorsData = authorSnapshot.val();
                    let userFound = false;
                    if (authorsData) {
                      for (const authorId in authorsData) {
                        const author = authorsData[authorId];
                        
                        if (author.name === username && author.password === password) {
                          userFound = true;
                          
                          // [FIX] កែសម្រួលតក្កវិជ្ជា (Logic) សម្រាប់ Single Device
                          // 1. អានតម្លៃ Setting ពី Admin
                          const enforce = (author.enforceSingleDevice === undefined) ? true : author.enforceSingleDevice;
                          
                          if (author.isBlocked === true) {
                            setError('គណនីរបស់អ្នកត្រូវបានបិទ។ សូមទាក់ទង Admin។');
                          
                          // 2. ពិនិត្យ isLoggedIn (true) តែនៅពេល enforce (true)
                          } else if (enforce && author.isLoggedIn === true) {
                            setError('គណនីនេះកំពុងប្រើប្រាស់លើឧបករណ៍ផ្សេង។');

                          } else {
                            // 3. អនុញ្ញាតឱ្យ Login (បើ enforce = false ឬ isLoggedIn = false)
                            onLogin({ 
                              name: author.name, 
                              role: 'user',
                              id: authorId,
                              permissions: author.permissions || { canAddLink: true, canEditLink: true, canDeleteLink: true }
                            });
                          }
                          break;
                        }
                      }
                    }
                    if (!userFound && !error) { 
                      setError('ឈ្មោះគណនី ឬពាក្យសម្ងាត់មិនត្រឹមត្រូវ');
                    }
                  })
                  .catch((err) => {
                    console.error(err);
                    setError('មានបញ្ហាក្នុងការពិនិត្យគណនី User');
                  })
                  .finally(() => {
                    setLoading(false);
                  });

              })
              .catch((err) => {
                console.error(err);
                setError('មានបញ្ហាក្នុងការពិនិត្យគណនី Admin');
                setLoading(false);
              });
          };

          return (
            <div className="min-h-screen flex items-center justify-center p-4">
              <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl">
                <h1 className="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-500 mb-6">
                  ចូលប្រព័ន្ធ
                </h1>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">ឈ្មោះគណនី</label>
                    <div className="relative">
                      <span className="absolute inset-y-0 left-0 pl-3 flex items-center">
                        <UserIcon />
                      </span>
                      <input
                        type="text"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        className="border border-gray-300 rounded-md px-10 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="ឧ. admin ឬ Sok"
                        required
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                    <div className="relative">
                      <span className="absolute inset-y-0 left-0 pl-3 flex items-center">
                        <LockIcon />
                      </span>
                      <input
                        type={showPassword ? 'text' : 'password'} 
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="border border-gray-300 rounded-md px-10 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
                        placeholder="••••••••"
                        required
                      />
                      <span 
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500"
                      >
                        {showPassword ? <EyeOffIcon /> : <EyeIcon />}
                      </span>
                    </div>
                  </div>
                  
                  {error && (
                    <p className="text-red-500 text-sm text-center">{error}</p>
                  )}
                  
                  <button
                    type="submit"
                    className={`w-full flex items-center justify-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-200 font-semibold ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    disabled={loading}
                  >
                    {loading ? (
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    ) : (
                      <span>ចូលប្រព័ន្ធ</span>
                    )}
                  </button>
                </form>
              </div>
            </div>
          );
        }
        
        // --- Component: AddLinkForm ---
        function AddLinkForm({ authorId, onAddLink, canAddLink }) {
          const [title, setTitle] = useState('');
          const [url, setUrl] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!title || !url) return;
            let correctedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              correctedUrl = 'https://' + url;
            }
            onAddLink(authorId, title, correctedUrl);
            setTitle('');
            setUrl('');
          };

          if (!canAddLink) {
            return (
                <p className="text-center text-sm text-gray-400 mt-4 p-4 bg-gray-50 rounded-lg italic">
                    អ្នកមិនមានសិទ្ធិបន្ថែមតំណថ្មីទេ។
                </p>
            );
          }

          return (
            <form onSubmit={handleSubmit} className="mt-4 p-4 bg-gray-50 rounded-lg">
              <h4 className="font-semibold text-gray-700 mb-3">បន្ថែមតំណថ្មី</h4>
              <div className="flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0">
                <input
                  type="text"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="ចំណងជើង (ឧ. គេហទំព័រ Google)"
                  className="border border-gray-300 rounded-md px-3 py-2 flex-grow w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-green-500"
                  required
                />
                <input
                  type="text"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  placeholder="តំណ URL (ឧ. google.com)"
                  className="border border-gray-300 rounded-md px-3 py-2 flex-grow w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-green-500"
                  required
                />
                <button
                  type="submit"
                  className="flex items-center justify-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200"
                >
                  <PlusIcon />
                  <span>រក្សាទុកតំណ</span>
                </button>
              </div>
            </form>
          );
        }
        
        // --- Component ថ្មី: LinkItem (សម្រាប់ Edit Link) ---
        function LinkItem({ authorId, link, linkId, canEdit, canDelete, onUpdateLink, onDeleteLink }) {
          const [isEditing, setIsEditing] = useState(false);
          const [editTitle, setEditTitle] = useState(link.title);
          const [editUrl, setEditUrl] = useState(link.url);

          const handleSaveLink = () => {
            let correctedUrl = editUrl;
            if (!editUrl.startsWith('http://') && !editUrl.startsWith('https://')) {
              correctedUrl = 'https://' + editUrl;
            }
            
            if (editTitle.trim() && correctedUrl.trim()) {
              onUpdateLink(authorId, linkId, editTitle, correctedUrl);
              setIsEditing(false);
            }
          };

          const handleCancelLink = () => {
            setEditTitle(link.title);
            setEditUrl(link.url);
            setIsEditing(false);
          };

          const formatKhmerDateTime = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            const options = { day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            return new Intl.DateTimeFormat('km-KH', options).format(date);
          };

          if (isEditing) {
            return (
              <li className="bg-white p-3 rounded-md border border-blue-300 shadow-md">
                <div className="flex items-center space-x-3 mb-2">
                  <div className="flex-shrink-0 bg-gray-100 p-2 rounded-full"><LinkIcon /></div>
                  <input
                    type="text"
                    value={editTitle}
                    onChange={(e) => setEditTitle(e.target.value)}
                    className="text-lg font-semibold border-b-2 border-blue-500 focus:outline-none w-full"
                  />
                </div>
                <input
                  type="text"
                  value={editUrl}
                  onChange={(e) => setEditUrl(e.target.value)}
                  className="text-sm text-gray-700 border-b border-gray-400 focus:outline-none w-full mb-2"
                />
                <div className="flex items-center justify-end space-x-2">
                  <button onClick={handleCancelLink} className="bg-gray-400 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-500">បោះបង់</button>
                  <button onClick={handleSaveLink} className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">រក្សាទុក</button>
                </div>
              </li>
            );
          }

          return (
            <li className="flex justify-between items-center group bg-white p-3 rounded-md border border-gray-200 hover:bg-gray-50">
              <div className="flex items-center space-x-3">
                <div className="flex-shrink-0 bg-gray-100 p-2 rounded-full"><LinkIcon /></div>
                <div>
                  <a href={link.url} target="_blank" rel="noopener noreferrer" className="text-lg font-semibold text-blue-700 hover:underline">
                    {link.title}
                  </a>
                  {link.createdAt && (<p className="text-xs text-gray-500 mt-1">{formatKhmerDateTime(link.createdAt)}</p>)}
                </div>
              </div>
              <div className="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                {canEdit && (
                  <button onClick={() => setIsEditing(true)} className="text-gray-400 hover:text-blue-500 p-1" title="កែសម្រួលតំណនេះ">
                    <EditIcon />
                  </button>
                )}
                {canDelete && (
                  <button onClick={() => onDeleteLink(authorId, link.id)} className="text-gray-400 hover:text-red-500 p-1" title="លុបតំណនេះ">
                    <TrashIcon />
                  </button>
                )}
              </div>
            </li>
          );
        }

        // --- Component: AuthorCard ---
        function AuthorCard({ 
          authorId, 
          author, 
          user, 
          onDeleteAuthor, 
          onAddLink, 
          onDeleteLink, 
          onUpdateAuthorName,
          onSetPassword,
          onUpdateLink,
          onUpdatePermissions,
          onForceLogout 
        }) {
          const links = author.links || {};
          const [isEditing, setIsEditing] = useState(false);
          const [editedName, setEditedName] = useState(author.name);
          
          const [newPassword, setNewPassword] = useState('');
          const [isSettingPassword, setIsSettingPassword] = useState(false);
          const [showNewPassword, setShowNewPassword] = useState(false);
          
          const userRole = user.role;
          let perms;
          if (userRole === 'admin') {
             perms = {
              canAddLink: true,
              canEditLink: true,
              canDeleteLink: true,
              ...(author.permissions || {})
            };
          } else {
            perms = user.permissions;
          }
          
          const isBlocked = author.isBlocked || false;
          const isLoggedIn = author.isLoggedIn || false;
          const enforceSingleDevice = author.enforceSingleDevice === undefined ? true : author.enforceSingleDevice;

          const sortedLinks = Object.keys(links)
            .map(key => ({ id: key, ...links[key] }))
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          const handleSaveName = () => {
            if (editedName.trim() && editedName !== author.name) {
              onUpdateAuthorName(authorId, editedName.trim());
            }
            setIsEditing(false);
          };

          const handleCancelEdit = () => {
            setEditedName(author.name);
            setIsEditing(false);
          };
          
          const handleSetPassword = () => {
            if (newPassword.trim()) {
              onSetPassword(authorId, newPassword.trim());
              setNewPassword('');
              setIsSettingPassword(false);
              setShowNewPassword(false);
            }
          };
          
          const handlePermissionChange = (permKey, value) => {
             onUpdatePermissions(authorId, { [`permissions/${permKey}`]: value });
          };
          
          const handleBlockToggle = (value) => {
              onUpdatePermissions(authorId, { 'isBlocked': value, 'isLoggedIn': false });
          };
          
          const handleEnforceToggle = (value) => {
              onUpdatePermissions(authorId, { 'enforceSingleDevice': value });
          };

          return (
            <div className={`bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6 transition-all duration-300 ${isBlocked ? 'opacity-50 bg-gray-100' : ''}`}>
              <div className="flex justify-between items-center mb-4">
                {isEditing && userRole === 'admin' ? (
                  <div className="flex-grow flex items-center space-x-2">
                    <input type="text" value={editedName} onChange={(e) => setEditedName(e.target.value)} className="text-2xl font-bold text-indigo-700 border-b-2 border-indigo-500 focus:outline-none flex-grow" autoFocus />
                    <button onClick={handleSaveName} className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">រក្សាទុក</button>
                    <button onClick={handleCancelEdit} className="bg-gray-400 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-500">បោះបង់</button>
                  </div>
                ) : (
                  <div className="flex items-center space-x-3">
                    <h3 className={`text-2xl font-bold ${isBlocked ? 'text-red-600' : 'text-indigo-700'}`}>
                        {author.name}
                        {isBlocked && ' (បានបិទ)'}
                    </h3>
                    {userRole === 'admin' && (
                      <button onClick={() => setIsEditing(true)} className="text-gray-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-100 transition duration-200" title="កែសម្រួលឈ្មោះ">
                        <EditIcon />
                      </button>
                    )}
                  </div>
                )}
                
                {!isEditing && userRole === 'admin' && (
                  <button
                    onClick={() => onDeleteAuthor(authorId)}
                    className="flex items-center space-x-1 text-red-500 hover:text-red-700 hover:bg-red-100 p-2 rounded-md transition duration-200"
                    title="លុបអ្នកអភិវឌ្ឍន៍នេះ"
                  >
                    <TrashIcon />
                    <span className="text-sm font-medium hidden sm:block">លុបអ្នកអភិវឌ្ឍន៍</span>
                  </button>
                )}
              </div>
              
              {userRole === 'admin' && (
                <div className="flex items-center space-x-2 mb-4">
                  <span className={`h-3 w-3 rounded-full ${isLoggedIn ? 'bg-green-500' : 'bg-gray-400'}`}></span>
                  <span className="text-sm font-medium text-gray-600">
                    ស្ថានភាព៖ {isLoggedIn ? <span className="text-green-600">សកម្ម</span> : 'អសកម្ម'}
                  </span>
                  {isLoggedIn && (
                     <button 
                        onClick={() => onForceLogout(authorId)}
                        className="text-xs text-blue-600 hover:text-blue-800 p-1 bg-blue-100 rounded-md ml-4"
                     >
                        ដកឧបករណ៍ចេញ
                     </button>
                  )}
                </div>
              )}
              
              {userRole === 'admin' && (
                <div className="space-y-3 mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                  <div>
                    {isSettingPassword ? (
                      <div className="flex flex-col sm:flex-row items-stretch sm:items-center sm:space-x-2 space-y-2 sm:space-y-0">
                        <KeyIcon className="hidden sm:block" />
                        <div className="relative flex-grow">
                          <input 
                            type={showNewPassword ? 'text' : 'password'}
                            placeholder="ពាក្យសម្ងាត់ថ្មី..." 
                            value={newPassword} 
                            onChange={(e) => setNewPassword(e.target.value)} 
                            className="border border-gray-300 rounded-md px-3 py-1 w-full focus:outline-none focus:ring-1 focus:ring-blue-500 pr-10"
                          />
                          <span 
                            onClick={() => setShowNewPassword(!showNewPassword)}
                            className="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500"
                          >
                            {showNewPassword ? <EyeOffIcon /> : <EyeIcon />}
                          </span>
                        </div>
                        
                        <button onClick={handleSetPassword} className="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">រក្សាទុក</button>
                        <button onClick={() => setIsSettingPassword(false)} className="bg-gray-400 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-500">បោះបង់</button>
                      </div>
                    ) : (
                      <button onClick={() => setIsSettingPassword(true)} className="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-800 p-1">
                        <KeyIcon />
                        <span>កំណត់/ប្ដូរពាក្យសម្ងាត់ (ពាក្យសម្ងាត់៖ {author.password ? '***' : 'មិនទាន់កំណត់'})</span>
                      </button>
                    )}
                  </div>
                  
                  <div className="flex items-center justify-between p-2 bg-blue-50 rounded-md">
                    <label htmlFor={`enforce-${authorId}`} className="font-semibold text-blue-700">កំណត់ត្រឹម ១ ឧបករណ៍</label>
                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input 
                            type="checkbox" 
                            name={`enforce-${authorId}`}
                            id={`enforce-${authorId}`}
                            checked={enforceSingleDevice}
                            onChange={(e) => handleEnforceToggle(e.target.checked)}
                            className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                        />
                        <label 
                            htmlFor={`enforce-${authorId}`}
                            className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer">
                        </label>
                    </div>
                  </div>
                  
                  <div className="flex items-center justify-between p-2 bg-red-50 rounded-md">
                    <label htmlFor={`block-${authorId}`} className="font-semibold text-red-700">បិទគណនី</label>
                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input 
                            type="checkbox" 
                            name={`block-${authorId}`}
                            id={`block-${authorId}`}
                            checked={isBlocked}
                            onChange={(e) => handleBlockToggle(e.target.checked)}
                            className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                        />
                        <label 
                            htmlFor={`block-${authorId}`}
                            className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer">
                        </label>
                    </div>
                  </div>
                  
                  <div className="space-y-1">
                      <h4 className="font-semibold text-gray-700">កំណត់សិទ្ធិ</h4>
                      <div className="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0 items-start">
                        <label className="flex items-center space-x-2">
                            <input type="checkbox" className="h-5 w-5" checked={perms.canAddLink} onChange={(e) => handlePermissionChange('canAddLink', e.target.checked)} />
                            <span>អនុញ្ញាតឱ្យបន្ថែម</span>
                        </label>
                        <label className="flex items-center space-x-2">
                            <input type="checkbox" className="h-5 w-5" checked={perms.canEditLink} onChange={(e) => handlePermissionChange('canEditLink', e.target.checked)} />
                            <span>អនុញ្ញាតឱ្យកែ</span>
                        </label>
                        <label className="flex items-center space-x-2">
                            <input type="checkbox" className="h-5 w-5" checked={perms.canDeleteLink} onChange={(e) => handlePermissionChange('canDeleteLink', e.target.checked)} />
                            <span>អនុញ្ញាតឱ្យលុប</span>
                        </label>
                      </div>
                  </div>
                </div>
              )}

              {/* បញ្ជី Links */}
              {sortedLinks.length > 0 ? (
                <ul className="space-y-3">
                  {sortedLinks.map(link => (
                    <LinkItem
                      key={link.id}
                      authorId={authorId}
                      link={link}
                      linkId={link.id}
                      canEdit={perms.canEditLink}
                      canDelete={perms.canDeleteLink}
                      onUpdateLink={onUpdateLink}
                      onDeleteLink={onDeleteLink}
                    />
                  ))}
                </ul>
              ) : (
                <p className="text-gray-500 italic text-center py-4">មិនទាន់មានតំណណាមួយត្រូវបានបន្ថែមទេ។</p>
              )}
              
              <AddLinkForm 
                authorId={authorId} 
                onAddLink={onAddLink} 
                canAddLink={perms.canAddLink} 
              />
            </div>
          );
        }

        // --- Component: LinkManager ---
        function LinkManager({ user, onLogout }) {
          const [authors, setAuthors] = useState({});
          const [loading, setLoading] = useState(true);
          
          const [newAuthorName, setNewAuthorName] = useState('');
          const [newAuthorPassword, setNewAuthorPassword] = useState('');
          const [showNewAuthorPassword, setShowNewAuthorPassword] = useState(false);

          useEffect(() => {
            let authorsRef;
            
            if (user.role === 'admin') {
              authorsRef = db.ref('authors');
            } else if (user.role === 'user') {
              authorsRef = db.ref(`authors/${user.id}`);
            }

            const listener = authorsRef.on('value', (snapshot) => {
              const data = snapshot.val();
              
              if (user.role === 'admin') {
                setAuthors(data || {}); 
              } else if (user.role === 'user') {
                setAuthors(data ? { [user.id]: data } : {});
                
                if (data && data.permissions) {
                   user.permissions = data.permissions;
                }
                if (data && data.isBlocked === true) {
                    alert("គណនីរបស់អ្នកត្រូវបានបិទដោយ Admin។");
                    onLogout();
                }
              }
              setLoading(false);
            }, (error) => {
              console.error("Firebase read failed: ", error);
              setLoading(false);
            });

            return () => {
              authorsRef.off('value', listener);
            };
          }, [user, onLogout]);

          const handleAddAuthor = (e) => {
            e.preventDefault();
            if (!newAuthorName.trim() || !newAuthorPassword.trim()) {
              alert("សូមបញ្ចូលទាំងឈ្មោះ និងពាក្យសម្ងាត់");
              return;
            }
            const authorsListRef = db.ref('authors');
            const newAuthorRef = authorsListRef.push(); 
            newAuthorRef.set({
              name: newAuthorName,
              password: newAuthorPassword,
              isBlocked: false,
              isLoggedIn: false,
              enforceSingleDevice: true, 
              permissions: {
                canAddLink: true,
                canEditLink: true,
                canDeleteLink: true
              }
            })
            .then(() => {
              setNewAuthorName(''); 
              setNewAuthorPassword('');
              setShowNewAuthorPassword(false);
            })
            .catch((error) => console.error("Error adding author: ", error));
          };
          const handleDeleteAuthor = (authorId) => {
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.remove().catch((error) => console.error("Error deleting author: ", error));
          };
          const handleAddLink = (authorId, title, url) => {
            const linksRef = db.ref(`authors/${authorId}/links`);
            const newLinkRef = linksRef.push(); 
            newLinkRef.set({
              title: title,
              url: url,
              createdAt: new Date().toISOString() 
            }).catch((error) => console.error("Error adding link: ", error));
          };
          const handleDeleteLink = (authorId, linkId) => {
            const linkRef = db.ref(`authors/${authorId}/links/${linkId}`);
            linkRef.remove().catch((error) => console.error("Error deleting link: ", error));
          };
          const handleUpdateLink = (authorId, linkId, newTitle, newUrl) => {
            const linkRef = db.ref(`authors/${authorId}/links/${linkId}`);
            linkRef.update({
              title: newTitle,
              url: newUrl
            }).catch((error) => console.error("Error updating link: ", error));
          };
          const handleUpdateAuthorName = (authorId, newName) => {
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.update({ name: newName }).catch((error) => console.error("Error updating author name: ", error));
          };
          const handleSetPassword = (authorId, password) => {
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.update({ password: password }).catch((error) => console.error("Error setting password: ", error));
          };
          const handleUpdatePermissions = (authorId, permUpdates) => {
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.update(permUpdates).catch((error) => console.error("Error updating permissions: ", error));
          };
          
          const handleForceLogout = (authorId) => {
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.update({ isLoggedIn: false }); 
          };
          
          const authorIds = Object.keys(authors);

          return (
            <div className="min-h-screen p-4 sm:p-8">
              <div className="max-w-5xl mx-auto">
                
                <header className="flex justify-between items-center mb-6">
                  <div>
                    <h2 className="text-xl font-semibold text-gray-700">ស្វាគមន៍, <span className="font-bold text-indigo-700">{user.name}</span>!</h2>
                    <p className="text-sm text-gray-500">
                      {user.role === 'admin' ? 'អ្នកកំពុងចូលជា Admin' : 'អ្នកកំពុងចូលជា អ្នកអភិវឌ្ឍន៍'}
                    </p>
                  </div>
                  <button
                    onClick={onLogout}
                    className="flex items-center space-x-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-200 font-semibold"
                  >
                    <LogoutIcon />
                    <span>ចាកចេញ</span>
                  </button>
                </header>
                
                <div className="bg-white shadow-xl rounded-xl p-6 sm:p-8 pb-20 sm:pb-8">
                  <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-500 mb-8 text-center">
                    កម្មវិធីគ្រប់គ្រងតំណគេហទំព័រ
                  </h1>
                  
                  {user.role === 'admin' && (
                    <form onSubmit={handleAddAuthor} className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-10 p-4 bg-gray-100 rounded-lg">
                      <input
                        type="text"
                        value={newAuthorName}
                        onChange={(e) => setNewAuthorName(e.target.value)}
                        placeholder="បញ្ចូលឈ្មោះអ្នកអភិវឌ្ឍន៍"
                        className="border border-gray-300 rounded-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                      />
                      <div className="relative">
                        <input
                          type={showNewAuthorPassword ? 'text' : 'password'}
                          value={newAuthorPassword}
                          onChange={(e) => setNewAuthorPassword(e.target.value)}
                          placeholder="កំណត់ពាក្យសម្ងាត់"
                          className="border border-gray-300 rounded-md px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
                          required
                        />
                        <span 
                          onClick={() => setShowNewAuthorPassword(!showNewAuthorPassword)}
                          className="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500"
                        >
                          {showNewAuthorPassword ? <EyeOffIcon /> : <EyeIcon />}
                        </span>
                      </div>
                      <button
                        type="submit"
                        className="flex items-center justify-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-200 font-semibold"
                      >
                        <PlusIcon />
                        <span>បន្ថែមអ្នកអភិវឌ្ឍន៍</span>
                      </button>
                    </form>
                  )}

                  <div>
                    {loading && <p className="text-center text-gray-500 text-lg">កំពុងទាញយកទិន្នន័យ...</p>}
                    
                    {!loading && authorIds.length === 0 && (
                      <p className="text-center text-gray-500 italic text-lg py-10">
                        {user.role === 'admin' ? 'មិនទាន់មានក្រុមអ្នកអភិវឌ្ឍន៍។ សូមចាប់ផ្ដើមបន្ថែម។' : 'មិនទាន់មានទិន្នន័យសម្រាប់អ្នកទេ។'}
                      </p>
                    )}

                    {authorIds.length > 0 && (
                      <div className="space-y-6">
                        {authorIds.map((id) => (
                          <AuthorCard
                            key={id}
                            authorId={id}
                            author={authors[id]}
                            user={user}
                            onDeleteAuthor={handleDeleteAuthor}
                            onAddLink={handleAddLink}
                            onDeleteLink={handleDeleteLink}
                            onUpdateLink={handleUpdateLink}
                            onUpdateAuthorName={handleUpdateAuthorName}
                            onSetPassword={handleSetPassword}
                            onUpdatePermissions={handleUpdatePermissions}
                            onForceLogout={handleForceLogout} 
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <footer className="sm:hidden fixed bottom-0 left-0 w-full bg-indigo-700 text-white p-4 text-center shadow-lg-top">
                <p className="font-semibold">កម្មវិធីគ្រប់គ្រងតំណគេហទំព័រ</p>
              </footer>
            </div>
          );
        }
        
        // --- Component: MainApp ---
        function MainApp() {
          const [loggedInUser, setLoggedInUser] = useState(() => {
            try {
              const savedUser = localStorage.getItem('loggedInUser');
              if (savedUser) {
                return JSON.parse(savedUser);
              }
            } catch (e) {
              console.error("Failed to parse user from localStorage", e);
              localStorage.removeItem('loggedInUser');
            }
            return null;
          });

          useEffect(() => {
            let userPresenceRef = null;
            
            if (loggedInUser && loggedInUser.role === 'user') {
              userPresenceRef = db.ref(`authors/${loggedInUser.id}/isLoggedIn`);
              
              userPresenceRef.onDisconnect().set(false)
                .then(() => {
                    userPresenceRef.set(true);
                });
            }

            return () => {
              if (userPresenceRef) {
                userPresenceRef.onDisconnect().cancel();
              }
            };
          }, [loggedInUser]);

          const handleLogin = (user) => {
            try {
              localStorage.setItem('loggedInUser', JSON.stringify(user));
            } catch (e) {
              console.error("Failed to save user to localStorage", e);
            }
            setLoggedInUser(user);
          };

          const handleLogout = () => {
            try {
              localStorage.removeItem('loggedInUser');
            } catch (e) {
              console.error("Failed to remove user from localStorage", e);
            }

            if (loggedInUser && loggedInUser.role === 'user') {
              const userPresenceRef = db.ref(`authors/${loggedInUser.id}/isLoggedIn`);
              
              userPresenceRef.onDisconnect().cancel();
              
              userPresenceRef.set(false)
                .finally(() => {
                  setLoggedInUser(null);
                });
            } else {
              setLoggedInUser(null);
            }
          };

          if (!loggedInUser) {
            return <LoginForm onLogin={handleLogin} />;
          }

          return <LinkManager user={loggedInUser} onLogout={handleLogout} />;
        }

        // 8. ចាប់ផ្ដើម Render កម្មវិធី React ទៅក្នុង <div id="root">
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<MainApp />);

    </script>
</body>
</html>
