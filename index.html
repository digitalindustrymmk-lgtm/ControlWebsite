<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á˜áŸ’á˜áœá·á’á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ááŸ†áá‚áŸá á‘áŸ†á–áŸáš</title>
    
    <!-- 1. Táº£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Táº£i React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Táº£i Babel Standalone (Ä‘á»ƒ dá»‹ch JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Táº£i Google Font (Kantumruy Pro) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">
    
    <!-- 4.5 [FIX] Táº£i Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>
    
    <style>
      /* á¢á“á»áœááŸ’á font á‘áŸ…á›á¾á‘áŸ†á–áŸášá‘á¶áŸ†á„á˜á¼á› */
      body {
        font-family: 'Kantumruy Pro', sans-serif;
      }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-gray-50">

    <!-- 5. á“áŸáŸ‡á‚áºá‡á¶á€á“áŸ’á›áŸ‚á„áŠáŸ‚á› React App á“á¹á„á”á„áŸ’á á¶á‰ -->
    <div id="root"></div>

    <!-- 6. á“áŸáŸ‡á‚áºá‡á¶á€á¼áŠ React á‘á¶áŸ†á„á¢áŸáŸ‹ (á”á¶á“á…á˜áŸ’á›á„á–á¸ .jsx) -->
    <script type="text/babel">
        // á”áŸ’ášá¾ global variables á–á¸ script áá¶á„á›á¾
        const { useState, useEffect } = React;

        // 7. [FIX] á˜á·á“á…á¶áŸ†á”á¶á…áŸ‹ Destructure á‘áŸ á–áŸ’ášáŸ„áŸ‡á™á¾á„á“á¹á„á”áŸ’ášá¾ v8 syntax

        // --- áá¶á„á€áŸ’ášáŸ„á˜á“áŸáŸ‡á‚áºá‡á¶á€á¼áŠá‘á¶áŸ†á„á¢áŸáŸ‹áŠáŸ‚á›á”á¶á“á…á˜áŸ’á›á„á–á¸ link_manager_app.jsx ---

        // 1. á€á¶ášá€áŸ†áááŸ‹ášá…á“á¶áŸá˜áŸ’á–áŸá“áŸ’á’ Firebase ášá”áŸáŸ‹á¢áŸ’á“á€
        const firebaseConfig = {
          apiKey: "AIzaSyAuNfZqCCpZVR6Rz3nOGa3SxwGTfWy4wJQ",
          authDomain: "controlwebsite.firebaseapp.com",
          projectId: "controlwebsite",
          storageBucket: "controlwebsite.firebasestorage.app",
          messagingSenderId: "512653236361",
          appId: "1:512653236361:web:1d0f21a9ebe06724c1ce58",
          measurementId: "G-SDHGT81ZDY",
          databaseURL: "https://controlwebsite-default-rtdb.firebaseio.com"
        };

        // 2. á…á¶á”áŸ‹á•áŸ’áŠá¾á˜ Firebase (v8 compat syntax)
        const app = firebase.initializeApp(firebaseConfig);
        // ğŸš€ [FIX] á”áŸ’ášá¾ firebase.database() (v8) á‡áŸ†á“á½áŸ getDatabase(app) (v9)
        const db = firebase.database(app);

        // --- ášá¼á”ááŸ†áá¶á„ (Icons) á‡á¶ SVG ---
        const PlusIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v12m6-6H6" />
          </svg>
        );

        const TrashIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        );

        const LinkIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101" />
          </svg>
        );

        const EditIcon = () => (
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
          </svg>
        );
        // --- á…á”áŸ‹ á•áŸ’á“áŸ‚á€ášá¼á”ááŸ†áá¶á„ ---

        // Component áŸá˜áŸ’ášá¶á”áŸ‹á”á“áŸ’ááŸ‚á˜ Link
        function AddLinkForm({ authorId, onAddLink }) {
          const [title, setTitle] = useState('');
          const [url, setUrl] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!title || !url) {
              console.warn('áŸá¼á˜á”áŸ†á–áŸá‰á‘á¶áŸ†á„ á…áŸ†áá„á‡á¾á„ á“á·á„ URL');
              return;
            }
            let correctedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              correctedUrl = 'https://' + url;
            }
            
            onAddLink(authorId, title, correctedUrl);
            setTitle('');
            setUrl('');
          };

          return (
            <form onSubmit={handleSubmit} className="mt-4 p-4 bg-gray-50 rounded-lg">
              <h4 className="font-semibold text-gray-700 mb-3">á”á“áŸ’ááŸ‚á˜ááŸ†áááŸ’á˜á¸</h4>
              <div className="flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0">
                <input
                  type="text"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="á…áŸ†áá„á‡á¾á„ (á§. á‚áŸá á‘áŸ†á–áŸáš Google)"
                  className="border border-gray-300 rounded-md px-3 py-2 flex-grow w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-green-500"
                  required
                />
                <input
                  type="text"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  placeholder="ááŸ†á URL (á§. google.com)"
                  className="border border-gray-300 rounded-md px-3 py-2 flex-grow w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-green-500"
                  required
                />
                <button
                  type="submit"
                  className="flex items-center justify-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200"
                >
                  <PlusIcon />
                  <span>ášá€áŸ’áŸá¶á‘á»á€ááŸ†á</span>
                </button>
              </div>
            </form>
          );
        }

        // Component áŸá˜áŸ’ášá¶á”áŸ‹á”á„áŸ’á á¶á‰ Author á˜áŸ’á“á¶á€áŸ‹
        function AuthorCard({ authorId, author, onDeleteAuthor, onAddLink, onDeleteLink, onUpdateAuthorName }) {
          const links = author.links || {};
          const [isEditing, setIsEditing] = useState(false);
          const [editedName, setEditedName] = useState(author.name);

          const sortedLinks = Object.keys(links)
            .map(key => ({
              id: key,
              ...links[key]
            }))
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          const formatKhmerDateTime = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            const options = {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            };
            return new Intl.DateTimeFormat('km-KH', options).format(date);
          };

          const handleSaveName = () => {
            if (editedName.trim() && editedName !== author.name) {
              onUpdateAuthorName(authorId, editedName.trim());
            }
            setIsEditing(false);
          };

          const handleCancelEdit = () => {
            setEditedName(author.name);
            setIsEditing(false);
          };

          return (
            <div className="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6 transition-all duration-300">
              <div className="flex justify-between items-center mb-4">
                {isEditing ? (
                  <div className="flex-grow flex items-center space-x-2">
                    <input
                      type="text"
                      value={editedName}
                      onChange={(e) => setEditedName(e.target.value)}
                      className="text-2xl font-bold text-indigo-700 border-b-2 border-indigo-500 focus:outline-none flex-grow"
                      autoFocus
                    />
                    <button 
                      onClick={handleSaveName}
                      className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600"
                    >
                      ášá€áŸ’áŸá¶á‘á»á€
                    </button>
                    <button 
                      onClick={handleCancelEdit}
                      className="bg-gray-400 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-500"
                    >
                      á”áŸ„áŸ‡á”á„áŸ‹
                    </button>
                  </div>
                ) : (
                  <div className="flex items-center space-x-3">
                    <h3 className="text-2xl font-bold text-indigo-700">{author.name}</h3>
                    <button
                      onClick={() => setIsEditing(true)}
                      className="text-gray-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-100 transition duration-200"
                      title="á€áŸ‚áŸá˜áŸ’ášá½á›áˆáŸ’á˜áŸ„áŸ‡"
                    >
                      <EditIcon />
                    </button>
                  </div>
                )}
                
                {!isEditing && (
                  <button
                    onClick={() => onDeleteAuthor(authorId)}
                    className="flex items-center space-x-1 text-red-500 hover:text-red-700 hover:bg-red-100 p-2 rounded-md transition duration-200"
                    title="á›á»á”á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸá“áŸáŸ‡"
                  >
                    <TrashIcon />
                    <span className="text-sm font-medium hidden sm:block">á›á»á”á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸ</span>
                  </button>
                )}
              </div>

              {sortedLinks.length > 0 ? (
                <ul className="space-y-3">
                  {sortedLinks.map(link => (
                    <li key={link.id} className="flex justify-between items-center group bg-white p-3 rounded-md border border-gray-200 hover:bg-gray-50">
                      <div className="flex items-center space-x-3">
                        <div className="flex-shrink-0 bg-gray-100 p-2 rounded-full">
                          <LinkIcon />
                        </div>
                        <div>
                          <a
                            href={link.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-lg font-semibold text-blue-700 hover:underline"
                          >
                            {link.title}
                          </a>
                          {link.createdAt && (
                            <p className="text-xs text-gray-500 mt-1">
                              {formatKhmerDateTime(link.createdAt)}
                            </p>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => onDeleteLink(authorId, link.id)}
                        className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1"
                        title="á›á»á”ááŸ†áá“áŸáŸ‡"
                      >
                        <TrashIcon />
                      </button>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-gray-500 italic text-center py-4">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“ááŸ†ááá¶á˜á½á™ááŸ’ášá¼áœá”á¶á“á”á“áŸ’ááŸ‚á˜á‘áŸáŸ”</p>
              )}

              <AddLinkForm authorId={authorId} onAddLink={onAddLink} />
            </div>
          );
        }

        // 3. Main App Component (áŠá€ 'export default' á…áŸá‰)
        function App() {
          const [authors, setAuthors] = useState({});
          const [loading, setLoading] = useState(true);
          const [newAuthorName, setNewAuthorName] = useState('');

          useEffect(() => {
            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref() (v8)
            const authorsRef = db.ref('authors');
            
            // ğŸš€ [FIX] á”áŸ’ášá¾ .on('value', ...) (v8)
            const listener = authorsRef.on('value', (snapshot) => {
              const data = snapshot.val();
              setAuthors(data || {}); 
              setLoading(false);
            }, (error) => {
              console.error("Firebase read failed: ", error);
              setLoading(false);
            });

            // ğŸš€ [FIX] á”áŸ’ášá¾ .off() (v8)
            return () => {
              authorsRef.off('value', listener);
            };
          }, []); 

          const handleAddAuthor = (e) => {
            e.preventDefault();
            if (!newAuthorName.trim()) return; 

            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref().push() (v8)
            const authorsListRef = db.ref('authors');
            const newAuthorRef = authorsListRef.push(); 
            
            // ğŸš€ [FIX] á”áŸ’ášá¾ .set() (v8)
            newAuthorRef.set({
              name: newAuthorName
            })
            .then(() => {
              setNewAuthorName(''); 
            })
            .catch((error) => {
              console.error("Error adding author: ", error);
            });
          };

          const handleDeleteAuthor = (authorId) => {
            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref() á“á·á„ .remove() (v8)
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.remove()
              .catch((error) => {
                console.error("Error deleting author: ", error);
              });
          };

          const handleAddLink = (authorId, title, url) => {
            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref().push() (v8)
            const linksRef = db.ref(`authors/${authorId}/links`);
            const newLinkRef = linksRef.push(); 
            
            // ğŸš€ [FIX] á”áŸ’ášá¾ .set() (v8)
            newLinkRef.set({
              title: title,
              url: url,
              createdAt: new Date().toISOString() 
            })
            .catch((error) => {
              console.error("Error adding link: ", error);
            });
          };

          const handleDeleteLink = (authorId, linkId) => {
            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref() á“á·á„ .remove() (v8)
            const linkRef = db.ref(`authors/${authorId}/links/${linkId}`);
            linkRef.remove()
              .catch((error) => {
                console.error("Error deleting link: ", error);
              });
          };

          const handleUpdateAuthorName = (authorId, newName) => {
            // ğŸš€ [FIX] á”áŸ’ášá¾ db.ref() á“á·á„ .update() (v8)
            const authorRef = db.ref(`authors/${authorId}`);
            authorRef.update({
              name: newName
            })
            .catch((error) => {
              console.error("Error updating author name: ", error);
            });
          };

          const authorIds = Object.keys(authors);

          return (
            <div 
              className="min-h-screen p-4 sm:p-8"
            >
              <div className="max-w-5xl mx-auto">
                <div className="bg-white shadow-xl rounded-xl p-6 sm:p-8 pb-20 sm:pb-8">
                  <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-500 mb-8 text-center">
                    á€á˜áŸ’á˜áœá·á’á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ááŸ†áá‚áŸá á‘áŸ†á–áŸáš
                  </h1>

                  <form onSubmit={handleAddAuthor} className="flex flex-col sm:flex-row sm:space-x-3 mb-10">
                    <input
                      type="text"
                      value={newAuthorName}
                      onChange={(e) => setNewAuthorName(e.target.value)}
                      placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸ (á§. á›áŸ„á€á‚áŸ’ášá¼ áŸá»á)"
                      className="border border-gray-300 rounded-md px-4 py-3 flex-grow mb-2 sm:mb-0 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                    <button
                      type="submit"
                      className="flex items-center justify-center space-x-2 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-200 font-semibold"
                    >
                      <PlusIcon />
                      <span>á”á“áŸ’ááŸ‚á˜á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸ</span>
                    </button>
                  </form>

                  <div>
                    {loading && <p className="text-center text-gray-500 text-lg">á€áŸ†á–á»á„á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™...</p>}
                    
                    {!loading && authorIds.length === 0 && (
                      <p className="text-center text-gray-500 italic text-lg py-10">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á€áŸ’ášá»á˜á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸáŸ” áŸá¼á˜á…á¶á”áŸ‹á•áŸ’áŠá¾á˜á”á“áŸ’ááŸ‚á˜áŸ”</p>
                    )}

                    {authorIds.length > 0 && (
                      <div className="space-y-6">
                        {authorIds.map((id) => (
                          <AuthorCard
                            key={id}
                            authorId={id}
                            author={authors[id]}
                            onDeleteAuthor={handleDeleteAuthor}
                            onAddLink={handleAddLink}
                            onDeleteLink={handleDeleteLink}
                            onUpdateAuthorName={handleUpdateAuthorName}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <footer className="sm:hidden fixed bottom-0 left-0 w-full bg-indigo-700 text-white p-4 text-center shadow-lg-top">
                <p className="font-semibold">á€á˜áŸ’á˜áœá·á’á¸á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ááŸ†áá‚áŸá á‘áŸ†á–áŸáš</p>
              </footer>
            </div>
          );
        }

        // 8. á…á¶á”áŸ‹á•áŸ’áŠá¾á˜ Render á€á˜áŸ’á˜áœá·á’á¸ React á‘áŸ…á€áŸ’á“á»á„ <div id="root">
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
